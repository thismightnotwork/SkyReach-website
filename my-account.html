<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SkyReach Members Area - My Account</title>
  <link rel="icon" type="image/png" href="/assets/logo.png" />

  <link rel="manifest" href="/manifest.json" />
  <link rel="apple-touch-icon" href="/assets/logo.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="SkyReach" />

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0f172a;
      color: white;
      margin: 0; padding: 0;
    }
    header {
      background: #1e293b;
      padding: 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    header img {
      height: 50px;
    }
    nav {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 1rem;
    }
    nav a {
      color: #93c5fd;
      text-decoration: none;
      font-weight: bold;
    }
    nav a:hover {
      text-decoration: underline;
    }
    main {
      max-width: 900px;
      margin: 2rem auto;
      padding: 0 1rem;
      line-height: 1.6;
    }
    h1, h2 {
      text-align: center;
    }
    label {
      display: block;
      margin-top: 1rem;
      font-weight: bold;
    }
    input, button {
      margin-top: 0.5rem;
      padding: 0.5rem;
      width: 100%;
      max-width: 300px;
      border-radius: 5px;
      border: none;
      font-size: 1rem;
    }
    input {
      background: #1e293b;
      color: white;
    }
    input::placeholder {
      color: #94a3b8;
    }
    button {
      background-color: #2563eb;
      color: white;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover {
      background-color: #1e40af;
    }
    #logoutBtn {
      max-width: 150px;
      margin: 2rem auto 0 auto;
      display: block;
    }
    .info-box {
      margin-top: 1.5rem;
      padding: 1rem;
      background: #1e293b;
      border-radius: 8px;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
      text-align: left;
    }
    .stats {
      margin-top: 1rem;
      font-size: 1.1rem;
      background: #334155;
      border-radius: 6px;
      padding: 1rem;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }
    .stats p {
      margin: 0.4rem 0;
    }
    .small {
      font-size: 0.85rem;
      color: #94a3b8;
    }
    #saveMessage {
      margin-top: 1rem;
      font-weight: bold;
      min-height: 1.2rem;
    }
    #saveMessage.success {
      color: #4ade80; /* green */
    }
    #saveMessage.error {
      color: #f87171; /* red */
    }
  </style>
</head>
<body>

  <header>
    <img src="/assets/logo.png" alt="SkyReach Logo" />
    <nav>
      <a href="ivao-list.html">IVAO List</a>
      <a href="vatsim-list.html">VATSIM List</a>
      <a href="live-flights.html">Live Flights</a>
      <a href="events.html">Events</a>
      <a href="events-roster.html">Event Roster</a>
    </nav>
  </header>

  <main>
    <h1>My Account</h1>

    <div class="info-box">
      <p><strong>Logged in as:</strong> <span id="userEmail">Loading...</span></p>
      <label for="displayName">Display Name</label>
      <input type="text" id="displayName" placeholder="Your display name" />

      <label for="newskyId">NewSky ID</label>
      <input type="text" id="newskyId" placeholder="Your NewSky pilot ID (hex string)" />
      <p class="small">
        How to find your NewSky ID:<br />
        1. Log in to <a href="https://newsky.app" target="_blank" style="color:#93c5fd;">NewSky website</a>.<br />
        2. Click your profile and check the URL: your ID is the long hex string at the end.<br />
        Example URL: <code>https://newsky.app/pilot/67b7aa45dac6dc5765a8b7df</code>
      </p>

      <div class="stats" id="newskyStats" style="display:none;">
        <h2>NewSky Pilot Stats</h2>
        <p><strong>Hours Flown:</strong> <span id="hoursFlown">-</span></p>
        <p><strong>Flights:</strong> <span id="flightsCount">-</span></p>
        <p><strong>Average Landing Rate:</strong> <span id="landingRate">-</span> ft/min</p>
      </div>

      <button id="saveBtn" style="margin-top: 1.5rem;">Save Changes</button>
      <div id="saveMessage"></div>
    </div>

    <button id="logoutBtn">Log Out</button>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA92I8ATCslzGoveL_LFKproCkI0clq5XE",
      authDomain: "skyreach-login.firebaseapp.com",
      projectId: "skyreach-login",
      storageBucket: "skyreach-login.firebasestorage.app",
      messagingSenderId: "531909303327",
      appId: "1:531909303327:web:58f4b25a6b8023ef87c92a",
      measurementId: "G-3XKSQ6W4PY"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const userEmailSpan = document.getElementById('userEmail');
    const displayNameInput = document.getElementById('displayName');
    const newskyIdInput = document.getElementById('newskyId');
    const newskyStatsDiv = document.getElementById('newskyStats');
    const hoursFlownSpan = document.getElementById('hoursFlown');
    const flightsCountSpan = document.getElementById('flightsCount');
    const landingRateSpan = document.getElementById('landingRate');
    const saveBtn = document.getElementById('saveBtn');
    const saveMessage = document.getElementById('saveMessage');
    const logoutBtn = document.getElementById('logoutBtn');

    let currentUid = null;
    let userDocRef = null;

    const newskyToken = 'SRH_IkQ2nFKheLXMpbYHqJVhSjjkOFJrM1';

    function debounce(func, wait) {
      let timeout;
      return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "/login.html";
        return;
      }

      currentUid = user.uid;
      userEmailSpan.textContent = user.email || 'No email';

      userDocRef = doc(db, 'users', currentUid);
      const docSnap = await getDoc(userDocRef);

      if (docSnap.exists()) {
        const data = docSnap.data();
        displayNameInput.value = data.displayName || '';
        newskyIdInput.value = data.newskyID || '';

        if (newskyIdInput.value) {
          fetchNewSkyStats(newskyIdInput.value);
        }
      } else {
        await setDoc(userDocRef, {
          displayName: user.displayName || '',
          newskyID: ''
        });
      }
    });

    async function fetchNewSkyStats(newskyID) {
      if (!newskyID || newskyID.length < 10) {
        newskyStatsDiv.style.display = 'none';
        return;
      }

      try {
        hoursFlownSpan.textContent = 'Loading...';
        flightsCountSpan.textContent = 'Loading...';
        landingRateSpan.textContent = 'Loading...';
        newskyStatsDiv.style.display = 'block';

        const url = `https://newsky-flight.com/api/v1/pilots/${newskyID}?token=${newskyToken}`;
        const response = await fetch(url);

        if (!response.ok) {
          throw new Error('Failed to fetch from NewSky API');
        }

        const data = await response.json();

        if (data.success !== true) {
          throw new Error(data.message || 'NewSky API error');
        }

        const pilot = data.data;
        hoursFlownSpan.textContent = pilot.hours.toFixed(1);
        flightsCountSpan.textContent = pilot.flights;
        landingRateSpan.textContent = pilot.landingrate.toFixed(1);

      } catch (err) {
        newskyStatsDiv.style.display = 'none';
        console.error('NewSky API error:', err);
      }
    }

    newskyIdInput.addEventListener('input', debounce(() => {
      fetchNewSkyStats(newskyIdInput.value.trim());
    }, 800));

    saveBtn.addEventListener('click', async () => {
      const newDisplayName = displayNameInput.value.trim();
      const newskyID = newskyIdInput.value.trim();

      if (!currentUid) {
        saveMessage.textContent = 'User not authenticated.';
        saveMessage.className = 'error';
        return;
      }

      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';
      saveMessage.textContent = ''; // Clear previous message
      saveMessage.className = '';

      try {
        if (auth.currentUser.displayName !== newDisplayName) {
          await updateProfile(auth.currentUser, { displayName: newDisplayName });
        }

        await updateDoc(userDocRef, {
          displayName: newDisplayName,
          newskyID: newskyID
        });

        await fetchNewSkyStats(newskyID);

        saveMessage.textContent = 'Profile saved successfully!';
        saveMessage.className = 'success';
      } catch (err) {
        saveMessage.textContent = 'Failed to save profile: ' + err.message;
        saveMessage.className = 'error';
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save Changes';
      }
    });

    logoutBtn.addEventListener('click', () => {
      signOut(auth).then(() => {
        window.location.href = '/login.html';
      });
    });
  </script>
</body>
</html>
