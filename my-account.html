<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SkyReach - My Account</title>
  <link rel="icon" type="image/png" href="/assets/logo.png" />

  <!-- PWA manifest -->
  <link rel="manifest" href="/manifest.json" />

  <!-- Apple Touch Icon for iOS home screen -->
  <link rel="apple-touch-icon" href="/assets/logo.png" />

  <!-- Meta tags for iOS standalone mode -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="SkyReach" />

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0f172a;
      color: white;
      margin: 0; padding: 0;
    }
    header {
      background: #1e293b;
      padding: 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    header img {
      height: 50px;
    }
    nav {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 1rem;
    }
    nav a {
      color: #93c5fd;
      text-decoration: none;
      font-weight: bold;
    }
    nav a:hover {
      text-decoration: underline;
    }
    button#logoutBtn {
      background-color: #2563eb;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 5px;
      color: white;
      cursor: pointer;
      white-space: nowrap;
      font-weight: bold;
      font-size: 1rem;
    }
    button#logoutBtn:hover {
      background-color: #1e40af;
    }
    main {
      max-width: 900px;
      margin: 2rem auto;
      padding: 0 1rem;
      text-align: left;
      line-height: 1.6;
    }
    h1 {
      text-align: center;
      margin-bottom: 1rem;
    }

    label {
      display: block;
      font-size: 14px;
      color: #94a3b8;
      margin-top: 12px;
      margin-bottom: 4px;
    }
    input, select {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      border: none;
      background: #334155;
      color: white;
      box-sizing: border-box;
      font-size: 14px;
    }
    input::placeholder {
      color: #94a3b8;
    }
    .row {
      display: flex;
      gap: 10px;
      margin-top: 12px;
    }
    .row > div {
      flex: 1;
    }
    button {
      background-color: #2563eb;
      border: none;
      padding: 0.7rem 1rem;
      border-radius: 5px;
      color: white;
      cursor: pointer;
      font-weight: bold;
      font-size: 16px;
      margin-top: 16px;
      width: 100%;
    }
    button:hover {
      background-color: #1e40af;
    }
    button.btn-ghost {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.2);
      color: #94a3b8;
      font-weight: normal;
      width: auto;
      padding: 0.5rem 1rem;
      margin-top: 8px;
      margin-right: 10px;
      display: inline-block;
      cursor: pointer;
    }
    .btn-group {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 12px;
      justify-content: center;
    }
    #joinedAt {
      color: #94a3b8;
      font-size: 14px;
      margin-top: 20px;
      text-align: center;
    }
    footer {
      text-align: center;
      padding: 1rem 0;
      background: #1e293b;
      color: #ccc;
      font-size: 0.9rem;
      margin-top: 40px;
    }
  </style>
</head>
<body>
  <header>
    <img src="/assets/logo.png" alt="SkyReach Logo" />
    <nav>
      <a href="/ivao-list.html">IVAO List</a>
      <a href="/vatsim-list.html">VATSIM List</a>
      <a href="/live-flights.html">Live Flights</a>
      <a href="/events.html">Events</a>
      <a href="/events-roster.html">Event Roster</a>
      <a href="/my-account.html">My Account</a>
      <button id="logoutBtn">Log Out</button>
    </nav>
  </header>

  <main>
    <h1>My Account</h1>

    <label for="displayName">Display Name</label>
    <input id="displayName" placeholder="Name (what other pilots see)" />

    <label for="email">Email (can't change here)</label>
    <input id="email" type="email" disabled />

    <label for="hub">Hub</label>
    <select id="hub">
      <option value="EGCC">Manchester (EGCC)</option>
      <option value="EGGW">Luton (EGGW)</option>
      <option value="EGKK">Gatwick (EGKK)</option>
      <option value="EGPH">Edinburgh (EGPH)</option>
    </select>

    <label for="rank">Rank</label>
    <input id="rank" placeholder="Trainee / First Officer / Captain" />

    <label for="timezone">Timezone</label>
    <input id="timezone" placeholder="Europe/London" />

    <label><input id="notifications" type="checkbox" style="vertical-align: middle;" /> Enable notifications (email/discord)</label>

    <div class="btn-group">
      <button id="saveBtn">Save changes</button>
      <button id="resetPwdBtn" class="btn-ghost">Send password reset</button>
    </div>

    <div style="text-align:center;">
      <div id="joinedAt">Joined: —</div>
    </div>
  </main>

  <footer>
    &copy; 2025 SkyReach Virtual Airline — All rights reserved.
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut,
      updateProfile,
      sendPasswordResetEmail
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      updateDoc,
      onSnapshot,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA92I8ATCslzGoveL_LFKproCkI0clq5XE",
      authDomain: "skyreach-login.firebaseapp.com",
      projectId: "skyreach-login",
      storageBucket: "skyreach-login.firebasestorage.app",
      messagingSenderId: "531909303327",
      appId: "1:531909303327:web:58f4b25a6b8023ef87c92a",
      measurementId: "G-3XKSQ6W4PY"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const displayNameEl = document.getElementById('displayName');
    const emailEl = document.getElementById('email');
    const hubEl = document.getElementById('hub');
    const rankEl = document.getElementById('rank');
    const newskyEl = document.getElementById('newskyId');
    const hoursEl = document.getElementById('hours');
    const flightsEl = document.getElementById('flights');
    const themeEl = document.getElementById('theme');
    const timezoneEl = document.getElementById('timezone');
    const notificationsEl = document.getElementById('notifications');

    const saveBtn = document.getElementById('saveBtn');
    const resetPwdBtn = document.getElementById('resetPwdBtn');
    const logoutBtn = document.getElementById('logoutBtn');

    const joinedAtEl = document.getElementById('joinedAt');

    let currentUid = null;
    let userDocRef = null;

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "/login.html";
        return;
      }
      currentUid = user.uid;
      userDocRef = doc(db, 'users', currentUid);

      const docSnap = await getDoc(userDocRef);
      if (!docSnap.exists()) {
        await setDoc(userDocRef, {
          displayName: user.displayName || (user.email ? user.email.split('@')[0] : 'Pilot'),
          email: user.email || '',
          role: 'Pilot',
          hub: 'EGCC',
          rank: 'Trainee',
          newskyID: '',
          joinedAt: serverTimestamp(),
          hours: 0,
          flights: 0,
          settings: { theme: 'dark', timezone: 'Europe/London', notifications: true },
          avatarUrl: ''
        }, { merge: true });
      }

      onSnapshot(userDocRef, (s) => {
        const data = s.data();
        if (!data) return;

        displayNameEl.value = data.displayName || '';
        emailEl.value = data.email || (user.email || '');
        hubEl.value = data.hub || 'EGCC';
        rankEl.value = data.rank || 'Trainee';
        newskyEl.value = data.newskyID || '';
        hoursEl.value = data.hours ?? 0;
        flightsEl.value = data.flights ?? 0;
        themeEl.value = data.settings?.theme || 'dark';
        timezoneEl.value = data.settings?.timezone || 'Europe/London';
        notificationsEl.checked = !!data.settings?.notifications;

        joinedAtEl.textContent = data.joinedAt && data.joinedAt.toDate ? `Joined: ${data.joinedAt.toDate().toLocaleDateString()}` : 'Joined: —';
      });
    });

    saveBtn.addEventListener('click', async () => {
      try {
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';

        const newDisplayName = displayNameEl.value.trim();
        const updates = {
          displayName: newDisplayName,
          hub: hubEl.value,
          rank: rankEl.value.trim(),
          newskyID: newskyEl.value.trim(),
          hours: Number(hoursEl.value) || 0,
          flights: Number(flightsEl.value) || 0,
          settings: {
            theme: themeEl.value,
            timezone: timezoneEl.value.trim() || 'Europe/London',
            notifications: !!notificationsEl.checked
          }
        };

        if (auth.currentUser && auth.currentUser.displayName !== newDisplayName) {
          await updateProfile(auth.currentUser, { displayName: newDisplayName });
        }

        await updateDoc(userDocRef, updates);

        saveBtn.textContent = 'Saved';
        setTimeout(() => { saveBtn.textContent = 'Save changes'; }, 1200);
      } catch (err) {
        alert('Error saving profile: ' + (err.message || err));
        saveBtn.textContent = 'Save changes';
      } finally {
        saveBtn.disabled = false;
      }
    });

    resetPwdBtn.addEventListener('click', async () => {
      const email = emailEl.value;
      if (!email) {
        alert('No email');
        return;
      }
      try {
        await sendPasswordResetEmail(auth, email);
        alert('Password reset email sent to ' + email);
      } catch (err) {
        alert('Error sending reset email: ' + (err.message || err));
      }
    });

    logoutBtn.addEventListener('click', async () => {
      try {
        await signOut(auth);
        window.location.href = '/login.html';
      } catch (err) {
        alert('Logout failed: ' + (err.message || err));
      }
    });
  </script>
</body>
</html>
