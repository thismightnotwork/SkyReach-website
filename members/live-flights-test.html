<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SkyReach - Live Flights</title>
  <link rel="icon" type="image/png" href="/assets/logo.png" />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-sA+e2lVh5gGQpFVh8vKDJ6ar2Vbzy7eo1WjvZ/5oE1M="
    crossorigin=""
  />
  <style>
    body, html { margin: 0; padding: 0; height: 100%; background: #000; color: #fff; font-family: sans-serif; }
    #map { height: 100%; width: 100%; }
    .info { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7); padding: 10px; border-radius: 5px; z-index: 1000; max-width: 250px; }
    .flight-list { max-height: 400px; overflow-y: auto; margin-top: 5px; }
    .flight-item { cursor: pointer; padding: 2px 0; border-bottom: 1px solid #333; }
    .flight-item:hover { background: #222; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="info">
    <div id="status">Loading flights...</div>
    <div class="flight-list" id="flightList"></div>
  </div>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-o9N1j6LTVMShnHdx6mdF1odY6k9fS4T9g+Xh2j8mC3A="
    crossorigin=""
  ></script>

  <script>
    const map = L.map('map').setView([51.5, -0.1], 5);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const markers = new Map();
    const trails = new Map();
    let selectedId = null;

    const RENDER_BACKEND = 'https://https://live-map-vg55.onrender.com'; // <- CHANGE THIS

    function idFor(flight) {
      return flight.network + ':' + (flight.cid || flight.userId || flight.callsign);
    }

    function getLatLng(flight) {
      return [flight.latitude || flight.lastTrack?.latitude, flight.longitude || flight.lastTrack?.longitude];
    }

    function createMarker(flight) {
      const latlng = getLatLng(flight);
      const marker = L.circleMarker(latlng, {
        radius: 5,
        color: flight.network === 'IVAO' ? 'cyan' : 'orange',
        fillColor: flight.network === 'IVAO' ? 'cyan' : 'orange',
        fillOpacity: 1
      }).addTo(map);

      marker.bindTooltip(flight.callsign || '???', { permanent: true, direction: 'top' });
      marker.on('click', () => { selectedId = idFor(flight); showDetails(flight); });
      return marker;
    }

    function createTrail(flight) {
      const trail = L.polyline([], { color: flight.network === 'IVAO' ? 'cyan' : 'orange' }).addTo(map);
      return trail;
    }

    function showDetails(flight) {
      document.getElementById('status').innerText = `
        Callsign: ${flight.callsign || '???'}
        Network: ${flight.network}
        Altitude: ${flight.altitude || 'N/A'} ft
        Lat/Lon: ${getLatLng(flight).map(n => n.toFixed(4)).join(', ')}
      `;
    }

    async function fetchFlights() {
      try {
        const res = await fetch(`${RENDER_BACKEND}/flights`);
        const data = await res.json();
        return data.flights || [];
      } catch(e) {
        console.error(e);
        return [];
      }
    }

    async function updateFlights() {
      const flights = await fetchFlights();
      const seen = new Set();

      // Update markers & trails
      flights.forEach(f => {
        const id = idFor(f);
        seen.add(id);

        let marker = markers.get(id);
        if (!marker) {
          marker = createMarker(f);
          markers.set(id, marker);
        } else {
          marker.setLatLng(getLatLng(f));
        }

        let trail = trails.get(id);
        if (!trail) {
          trail = createTrail(f);
          trails.set(id, trail);
        }

        // Update trail points
        const points = f.points || [];
        trail.setLatLngs(points.map(p => [p.lat, p.lon]));
      });

      // Remove disconnected aircraft
      markers.forEach((m, id) => { if (!seen.has(id)) { map.removeLayer(m); markers.delete(id); } });
      trails.forEach((t, id) => { if (!seen.has(id)) { map.removeLayer(t); trails.delete(id); } });

      renderFlightList(flights);
      document.getElementById('status').innerText = `Showing ${flights.length} flights`;
    }

    function renderFlightList(flights) {
      const container = document.getElementById('flightList');
      container.innerHTML = '';
      flights.forEach(f => {
        const div = document.createElement('div');
        div.className = 'flight-item';
        div.innerText = `${f.callsign || '???'} (${f.network})`;
        div.onclick = () => { map.panTo(getLatLng(f)); selectedId = idFor(f); showDetails(f); };
        container.appendChild(div);
      });
    }

    // Initial load
    updateFlights();
    setInterval(updateFlights, 10000); // refresh every 10s
  </script>
</body>
</html>
